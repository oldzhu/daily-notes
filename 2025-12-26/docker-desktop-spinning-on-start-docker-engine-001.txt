I know why /run/guest-services is empty, yesterday I build the new wsl2 kernel which is forked from https://github.com/microsoft/WSL2-Linux-Kernel linux-msft-wsl-6.6.y branch but modified some code for amdgpu drivers to support gfx1151, I used the same .config to build the kernel and modules, and set .wslconfig to use the new build kernel, then I saw docker desktop hang on start the engine... after the server is reboot, previously before the machine was reboot, wsl --shtudown to use the new kernel still works. if I still want to use the new kernel, how to continue the troubleshooting to figure out which part is the root cause?

===========

This is a crucial detail! By switching to a custom kernel, you likely broke the Docker-specific kernel requirements or the way WSL2 handles 9P (Plan 9) mount points, which is exactly how those .sock files are "projected" into the VM.When you run a custom kernel, Docker's bootstrap process (which expects specific features like BINFMT_MISC, NETFILTER, and 9P_FS) may fail to initialize the internal services.Here is how to troubleshoot this specific custom kernel conflict:1. Check the 9P Mount Support (The "Socket" Pipe)The reason /run/guest-services is empty is that the Windows host can't mount the transport layer.Inside your docker-desktop WSL terminal, run:Bashzcat /proc/config.gz | grep -E "CONFIG_9P_FS|CONFIG_NET_9P|CONFIG_NET_9P_VIRTIO"
Requirement: These must be set to y or m. If they are missing, Windows cannot "drop" the socket files into the Linux environment.2. Verify Kernel "Taint" or Initialization ErrorsSince the kernel was swapped, the internal init process might be failing silently. Check the kernel ring buffer for errors specifically related to the Docker bootstrap:Bashdmesg | grep -iE "9p|docker|virtio|mount"
Look for errors like 9pnet_virtio: no channels available or mount failed.3. The "Module" MismatchIf you compiled your kernel with CONFIG_9P_FS=m (as a module) but didn't correctly install the modules into the docker-desktop distribution, the kernel won't be able to load the driver needed to see the Windows sockets.The Problem: When you swap kernels via .wslconfig, the existing WSL distros (like docker-desktop) don't automatically get your new /lib/modules/ folder.The Fix: You must copy your compiled modules into the docker-desktop distro:Bash# From your build environment (e.g., Ubuntu)
sudo make modules_install INSTALL_MOD_PATH=/mnt/c/temp/modules
# Then move them into the docker-desktop distro
4. Compare ConfigsDocker Desktop requires a very specific set of kernel flags to run its engine.Temporarily comment out the kernel=... line in your .wslconfig and restart WSL.Once Docker starts successfully, run:Bashcp /proc/config.gz /mnt/c/temp/working_config.gz
Re-enable your custom kernel, then compare your custom .config against the working_config. Specifically, look for CONFIG_CGROUPS, CONFIG_NAMESPACES, and CONFIG_IP_NF_FILTER.5. Test the Bridge ManuallyThe most likely culprit is that your custom kernel handles Virtio or Inter-process communication differently.Inside docker-desktop, try to manually mount a Windows path:Bashsudo mkdir /test_mount
sudo mount -t 9p -o trans=virtio,version=9p2000.L config /test_mount
If this fails: Your kernel's 9P/Virtio implementation is broken. Docker cannot work without this.If this works: The kernel is fine, but the Docker "init" process is crashing due to missing cgroup or namespace support in your build.Summary of Troubleshooting StepsSymptomLikely Kernel CauseEmpty /run/guest-servicesMissing CONFIG_9P_FS or CONFIG_NET_9P_VIRTIO.vpnkit process exists but loopsNetwork bridge drivers (CONFIG_TUN, CONFIG_BRIDGE) missing.Docker hangs at "Starting"CONFIG_CGROUP_DEVICE or CONFIG_MEMCG missing.
